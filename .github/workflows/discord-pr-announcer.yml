name: Discord PR Announcer
on:
  workflow_call:
    secrets:
      DISCORD_WEBHOOK:
        required: true
jobs:
  notify:
    name: Send PR Notification to Discord
    runs-on: ubuntu-latest
    steps:
      - name: Announce Pull Request Event
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ACTION: ${{ github.event.action }}
          MERGED: ${{ github.event.pull_request.merged }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          TARGET_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          # Determine status and styling based on action
          if [ "$ACTION" = "closed" ]; then
            if [ "$MERGED" = "true" ]; then
              STATUS="‚úÖ Pull Request Merged"
              COLOR=5763719
            else
              STATUS="‚ùå Pull Request Closed"
              COLOR=15548997
            fi
          elif [ "$ACTION" = "reopened" ]; then
            STATUS="üîÑ Pull Request Reopened"
            COLOR=16776960
          elif [ "$ACTION" = "ready_for_review" ]; then
            STATUS="üëÄ Ready for Review"
            COLOR=15105570
          else
            STATUS="üîî New Pull Request"
            COLOR=3447003
          fi

          # Build Discord embed payload
          PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --arg title "$PR_TITLE" \
            --arg url "$PR_URL" \
            --arg author "$PR_AUTHOR" \
            --arg branch "$PR_BRANCH" \
            --arg target "$TARGET_BRANCH" \
            --argjson color $COLOR \
            '{
              embeds: [
                {
                  title: $title,
                  url: $url,
                  color: $color,
                  fields: [
                    {
                      name: "Author",
                      value: $author,
                      inline: true
                    },
                    {
                      name: "Status",
                      value: $status,
                      inline: true
                    },
                    {
                      name: "Branches",
                      value: ("`" + $branch + "` ‚Üí `" + $target + "`"),
                      inline: false
                    }
                  ],
                  footer: {
                    text: "GitHub Pull Request"
                  },
                  timestamp: (now | todate)
                }
              ]
            }')

          curl -s -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"
